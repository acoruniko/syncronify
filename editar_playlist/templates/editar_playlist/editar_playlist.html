{% extends "base.html" %}
{% load static %}

{% block title %}Editar Playlist | {{ playlist.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'editar_playlist/css/editar_playlist.css' %}">
{% endblock %}

{% block content %}
<div id="mensaje-superior" style="display:none;"></div>
<div class="editar-container">
  <!-- Grid principal con 3 columnas -->
  <div class="editar-layout">
    
    <!-- Columna izquierda -->
    <div class="playlist-section">
      <!-- Header grande fijo -->
      <div class="playlist-header">
        {% if playlist.cover_url %}
          <img src="{{ playlist.cover_url }}" alt="Cover {{ playlist.nombre }}" class="playlist-cover-big">
        {% endif %}
        <div class="playlist-info-block">
          <h1 class="playlist-title {% if playlist.nombre|length > 40 %}long{% endif %}">
            {{ playlist.nombre }}
          </h1>
          {% if playlist.descripcion %}
            <p class="playlist-description">{{ playlist.descripcion }}</p>
          {% endif %}
          <p class="playlist-meta">
            {{ playlist.propietario }} ¬∑ {{ playlist.total_canciones }} canciones
          </p>
        </div>
      </div>

      <!-- Encabezado de canciones sticky -->
      <div class="songs-header sticky">
        <span class="col-idx">#</span>
        <span class="col-title">T√≠tulo</span>
        <span class="col-album">√Ålbum</span>
      </div>

      <!-- Lista de canciones -->
      <div id="lista-canciones" class="songs-list scroll-container">
        {% for c in canciones %}
          <div class="song-row" onclick="seleccionarCancion(this)" data-id="{{ c.id }}" data-relacion-id="{{ c.id_relacion }}">
            <span class="col-idx">{{ c.posicion|default:"‚Äî" }}</span>
            <span class="col-title">
              {% if c.cover_url %}
                <img src="{{ c.cover_url }}" alt="Cover {{ c.titulo }}" class="song-cover">
              {% endif %}
              {{ c.titulo }}
            </span>
            <span class="col-album">{{ c.album }}</span>
          </div>
        {% empty %}
          <p class="empty">Esta playlist no tiene canciones relacionadas.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Columna derecha: detalles y tareas -->
    <div class="details-section">
    <div class="detalle-box datos-cancion">
      <h3>Datos de la canci√≥n</h3>
      <div class="detalle-row">
        <div class="detalle-label">Nombre:</div>
        <div class="detalle-value" id="detalle-nombre">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Autor:</div>
        <div class="detalle-value" id="detalle-artistas">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">√Ålbum:</div>
        <div class="detalle-value" id="detalle-album">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Duraci√≥n:</div>
        <div class="detalle-value" id="detalle-duracion">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Agregada:</div>
        <div class="detalle-value" id="detalle-agregado">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Posici√≥n:</div>
        <div class="detalle-value" id="detalle-posicion">‚Äî</div>
      </div>
    </div>

    <div class="detalle-box tareas">
      <h3>Tareas asignadas</h3>
      <div class="tareas-header sticky">
        <span class="col-accion">Acci√≥n</span>
        <span class="col-posicion">#</span>
        <span class="col-estado">Estado</span>
        <span class="col-fecha">Fecha</span>
      </div>
      <div class="tareas-list scroll-container" id="lista-tareas">
        <p class="empty">No hay tareas asignadas.</p>
      </div>
      <div class="tarea-actions">
        <button class="action-btn" id="btn-agregar-tarea" disabled>Agregar Tarea</button>
        <button class="action-btn" id="btn-eliminar-tarea" disabled>Eliminar Tarea</button>
      </div>
    </div>
  </div>

    <!-- Columna derecha: acciones -->
   <div class="action-panel">
        <div class="action-buttons-vertical">
          {% if rate_limited %}
            <button class="action-btn primary" onclick="abrirModalAgregarCancion()" disabled>
              Agregar canci√≥n (bloqueado)
            </button>
          {% else %}
            <button class="action-btn primary" onclick="abrirModalAgregarCancion()">
              Agregar canci√≥n
            </button>
          {% endif %}
            <button class="action-btn" onclick="volverAtras()">Atr√°s</button>
        </div>
    </div>
  </div>
  
</div>

<div id="modal-tarea" class="modal hidden">
  <div class="modal-content">
    <h2>Programar Tarea</h2>

    <!-- Encabezado espec√≠fico del modal -->
    <div class="modal-header">
      <span class="col-accion">Acci√≥n</span>
      <span class="col-posicion">Posici√≥n</span>
      <span class="col-fecha">Fecha de Ejecuci√≥n</span>
    </div>

    <!-- Fila editable espec√≠fica del modal -->
    <div class="modal-row">
      <div class="col-accion">
        <select id="tipo-tarea">
          <option value="Posicionar">Posicionar</option>
          <option value="Eliminar">Eliminar</option>
          <option value="Agregar">Agregar</option>
        </select>
      </div>

      <div class="col-posicion">
        <select id="posicion"></select>
      </div>

      <div class="col-fecha">
        <input type="date" id="fecha-ejecucion">
      </div>
    </div>

    <!-- Campo extra solo si es "Agregar" -->
    <div id="col-extra" class="campo-dinamico"></div>

    <!-- Botones -->
    <div class="modal-actions">
      <button class="action-btn" id="btn-confirmar-tarea">Confirmar</button>
      <button class="action-btn" id="btn-cancelar-tarea">Cancelar</button>
    </div>
  </div>
</div>

<script>
  let canciones = JSON.parse('{{ canciones_json|escapejs }}');
  const playlistId = {{ playlist.id_playlist }};
  let totalCancionesConPendientes = {{ total_con_pendientes }};

  // Variables globales √∫tiles
  const totalCanciones = {{ playlist.total_canciones|default:0 }};
  let relacionSeleccionadaId = null; // id_relacion de la canci√≥n seleccionada
  let tareaSeleccionadaId = null;    // para eliminar tarea seleccionada (si implementas selecci√≥n en la lista)

// üëâ Modo del modal
  let modoAgregarCancion = false;

  // Abrir modal
  document.getElementById('btn-agregar-tarea').addEventListener('click', () => {
    if (!relacionSeleccionadaId) return;
    abrirModalTarea();
  });

  // Cerrar modal
  document.getElementById('btn-cancelar-tarea').addEventListener('click', cerrarModalTarea);

  function abrirModalTarea() {
    // Tipo por defecto
    const tipoSelect = document.getElementById('tipo-tarea');
    tipoSelect.disabled = false
    tipoSelect.value = 'Posicionar';
    actualizarCamposPorTipo();

    // Posiciones v√°lidas
    poblarPosiciones(totalCancionesConPendientes);

    // Fecha por defecto hoy
    const hoy = new Date().toISOString().slice(0, 10);
    document.getElementById('fecha-ejecucion').value = hoy;

    document.getElementById('modal-tarea').classList.remove('hidden');
  }

  function cerrarModalTarea() {
    document.getElementById('modal-tarea').classList.add('hidden');
    modoAgregarCancion = false; // üëâ resetear modo
  }

  // Mostrar/ocultar campos seg√∫n tipo
  document.getElementById('tipo-tarea').addEventListener('change', actualizarCamposPorTipo);

  function actualizarCamposPorTipo() {
    const tipo = document.getElementById("tipo-tarea").value;
    const posicionSelect = document.getElementById("posicion");
    const colExtra = document.getElementById("col-extra");

    if (tipo === "Eliminar") {
      posicionSelect.disabled = true;
      posicionSelect.innerHTML = `<option value="-">-</option>`;
      colExtra.innerHTML = "";
    }

    else if (tipo === "Posicionar") {
      posicionSelect.disabled = false;
      poblarPosiciones(totalCanciones);
      colExtra.innerHTML = "";
    }

    else if (tipo === "Agregar") {
      // Solo se ejecuta en modo normal, no en modo agregar canci√≥n
      posicionSelect.disabled = true;
      posicionSelect.innerHTML = `<option value="-">-</option>`;
      colExtra.innerHTML = `
        <input type="text" id="url-cancion" placeholder="https://open.spotify.com/track/...">
      `;
    }
  }

    // Poblar posiciones 1..N
  function poblarPosiciones(totalCanciones) {
    const posicionSelect = document.getElementById("posicion");
    posicionSelect.innerHTML = ""; // limpiar
    for (let i = 1; i <= totalCanciones; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      posicionSelect.appendChild(opt);
    }
  }

  function actualizarCamposPorTipo() {
    const tipo = document.getElementById("tipo-tarea").value;
    const posicionSelect = document.getElementById("posicion");
    const colExtra = document.getElementById("col-extra");

    if (tipo === "Eliminar") {
      posicionSelect.disabled = true;
      posicionSelect.innerHTML = `<option value="-">-</option>`;
      colExtra.innerHTML = "";
    } else if (tipo === "Posicionar") {
      posicionSelect.disabled = false;
      colExtra.innerHTML = "";
    } else if (tipo === "Agregar") {
      posicionSelect.disabled = true;
      colExtra.innerHTML = `
        <label for="url-cancion" class="label-url">URL de la canci√≥n</label>
        <input type="text" id="url-cancion" placeholder="https://open.spotify.com/track/..." class="input-url">
      `;
    }
  } 

// Confirmar agregar tarea
document.getElementById('btn-confirmar-tarea').addEventListener('click', async () => {
  const tipo = document.getElementById('tipo-tarea').value;
  const fecha = document.getElementById('fecha-ejecucion').value;
  const posicion = document.getElementById('posicion').value;

  // üëâ Si estamos en modo Agregar Canci√≥n, usamos otro flujo
  if (modoAgregarCancion) {
    await guardarAgregarCancion();
    return;
  }

  // üëâ Flujo normal de tareas
  const formData = new FormData();
  formData.append('relacion_id', relacionSeleccionadaId);
  formData.append('tipo', tipo);
  formData.append('fecha', fecha);

  if (tipo === 'Posicionar') {
    formData.append('posicion', posicion);
  }

  const csrfToken = getCookie('csrftoken');

  try {
    const resp = await fetch("{% url 'crear_tarea' playlist.id_playlist %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      body: formData
    });

    const data = await resp.json();

    if (!data.ok) {
      return; // el backend ya puso el mensaje en la barra superior
    }

    cerrarModalTarea();

    // üëâ Refrescar lista completa desde el servidor
    await refrescarTareas(relacionSeleccionadaId);
    await refrescarMensajes();

  } catch (e) {
    console.error("Error de red al crear la tarea", e);
  }
});

// Eliminar tarea
document.getElementById('btn-eliminar-tarea').addEventListener('click', async () => {
  if (!tareaSeleccionadaId) return;

  const c = canciones.find(x => x.id_relacion == relacionSeleccionadaId);
  const tarea = c?.tareas.find(t => t.id_tarea == tareaSeleccionadaId);
  const usuario = tarea?.usuario || "desconocido";

  const confirmacion = confirm(`¬øEst√° seguro de eliminar esta tarea programada por ${usuario}?`);
  if (!confirmacion) return;

  const csrfToken = getCookie('csrftoken');

  try {
    const resp = await fetch(
      "{% url 'eliminar_tarea' playlist.id_playlist 0 %}".replace("0", tareaSeleccionadaId),
      {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken }
      }
    );
    const data = await resp.json();

    if (!data.ok) {
      console.error("Error al eliminar tarea:", data.error || "Respuesta inv√°lida");
      return;
    }

    // üëâ Refrescar tareas desde el servidor
    tareaSeleccionadaId = null;
    await refrescarTareas(relacionSeleccionadaId);

    await refrescarMensajes();

    // üëâ Deshabilitar bot√≥n despu√©s de eliminar
    document.getElementById('btn-eliminar-tarea').disabled = true;

    // El mensaje de √©xito lo maneja Django (messages.success)
    console.log("Tarea eliminada correctamente");
  } catch (e) {
    console.error("Error de red al eliminar la tarea:", e);
  }
});

async function refrescarTareas(relacionId) {
  try {
    const resp = await fetch(`/editar_playlist/${playlistId}/relacion/${relacionId}/tareas/`);
    const data = await resp.json();

    if (!data.ok) {
      console.error("Error al refrescar tareas:", data.error || "Respuesta inv√°lida");
      return;
    }

    const c = canciones.find(x => x.id_relacion == relacionId);
    if (c) {
      c.tareas = data.tareas;   // üëâ actualizamos con lo que viene del servidor
      renderizarTareas(c);      // üëâ re-renderizamos la lista
    }
  } catch (e) {
    console.error("Error de red al refrescar tareas:", e);
  }
}

function renderizarTareas(c) {
  const lista = document.getElementById("lista-tareas");
  lista.innerHTML = "";

  if (c.tareas && c.tareas.length > 0) {
    c.tareas.forEach(t => {
      const row = document.createElement("div");
      row.className = "tarea-row";
      row.dataset.tareaId = t.id_tarea;

      row.innerHTML = `
        <span class="col-accion">${t.tipo}</span>
        <span class="col-posicion">${t.posicion || "‚Äî"}</span>
        <span class="col-estado">${t.estado}</span>
        <span class="col-fecha">${new Date(t.fecha_ejecucion).toLocaleDateString()}</span>
      `;

      // seleccionar tarea para eliminar
      row.addEventListener("click", () => {
        document.querySelectorAll(".tarea-row").forEach(x => x.classList.remove("selected"));
        row.classList.add("selected");
        tareaSeleccionadaId = t.id_tarea;
        document.getElementById("btn-eliminar-tarea").disabled = false;
      });

      lista.appendChild(row);
    });
  } else {
    lista.innerHTML = "<p class='empty'>No hay tareas asignadas.</p>";
  }
}

// Utilidad para CSRF
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
 
function seleccionarCancion(el) {
  // marcar selecci√≥n
  document.querySelectorAll('.song-row').forEach(r => r.classList.remove('selected'));
  el.classList.add('selected');

  // guardar id de relaci√≥n
  relacionSeleccionadaId = el.dataset.relacionId;
  document.getElementById('btn-agregar-tarea').disabled = !relacionSeleccionadaId;
  document.getElementById('btn-eliminar-tarea').disabled = true;

  // buscar canci√≥n en el JSON usando id_relacion
  const relacionId = el.dataset.relacionId;
  const c = canciones.find(x => x.id_relacion == relacionId);

  if (c) {
    // actualizar detalles
    document.getElementById("detalle-nombre").textContent = c.titulo;
    document.getElementById("detalle-artistas").textContent = c.artistas;
    document.getElementById("detalle-album").textContent = c.album;
    document.getElementById("detalle-duracion").textContent = c.duracion || "‚Äî";
    document.getElementById("detalle-agregado").textContent = c.fecha_agregado ? new Date(c.fecha_agregado).toLocaleDateString() : "‚Äî";
    document.getElementById("detalle-posicion").textContent = c.posicion || "‚Äî";

    // üëâ refresca y renderiza tareas correctas para esa relaci√≥n
    refrescarTareas(relacionId);
  }
}


  function volverAtras() {
    window.location.href = "{% url 'lista_playlist_home' %}";
  }


function abrirModalAgregarCancion() {
  modoAgregarCancion = true;
  const tipoSelect = document.getElementById("tipo-tarea");
  tipoSelect.value = "Agregar";
  tipoSelect.disabled = true;

  posicionSelect.disabled = false;
  poblarPosiciones(totalCancionesConPendientes + 1);

  colExtra.innerHTML = `
    <label for="url-cancion" class="label-url">URL de la canci√≥n</label>
    <input type="text" id="url-cancion" placeholder="https://open.spotify.com/track/..." class="input-url">
  `;

  const hoy = new Date().toISOString().slice(0, 10);
  fechaInput.value = hoy;

  document.getElementById("modal-tarea").classList.remove("hidden");
}

  async function refrescarMensajes() {
    try {
      const resp = await fetch("{% url 'mensajes_bar' %}");
      const html = await resp.text();
      document.querySelector(".topbar-center").innerHTML = html;
    } catch (e) {
      console.error("Error al refrescar mensajes:", e);
    }
  }

const tipoTareaSelect = document.getElementById("tipo-tarea");
const posicionSelect = document.getElementById("posicion");
const fechaInput = document.getElementById("fecha-ejecucion");
const colExtra = document.getElementById("col-extra");

// Inicializaci√≥n visual
function initModalTarea() {
  // Rellenar posiciones si no est√°n (ejemplo 1..100)
  if (posicionSelect.options.length === 0) {
    for (let i = 1; i <= 100; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      posicionSelect.appendChild(opt);
    }
  }

  // Estado inicial: "Posicionar"
  posicionSelect.disabled = false;
  colExtra.innerHTML = ""; // sin campo extra
}



tipoTareaSelect.addEventListener("change", () => {
  const tipo = tipoTareaSelect.value;

  if (tipo === "Eliminar") {
    posicionSelect.disabled = true;
    colExtra.innerHTML = ""; // sin extra
  } else if (tipo === "Posicionar") {
    posicionSelect.disabled = false;
    colExtra.innerHTML = ""; // sin extra
  } else if (tipo === "Agregar") {
    posicionSelect.disabled = true;
    colExtra.innerHTML = `
      <label for="url-cancion" class="label-url">URL de la canci√≥n</label>
      <input type="text" id="url-cancion" placeholder="https://open.spotify.com/track/..." class="input-url">
    `;
  }
});

async function guardarAgregarCancion() {
  const url = document.getElementById("url-cancion").value;
  const posicion = document.getElementById("posicion").value;
  const fecha = document.getElementById("fecha-ejecucion").value;

  const formData = new FormData();
  formData.append("url", url);
  formData.append("posicion", posicion);
  formData.append("fecha", fecha);

  const csrfToken = getCookie("csrftoken");

  const resp = await fetch(`/editar_playlist/agregar_cancion/${playlistId}/`, {
    method: "POST",
    headers: { "X-CSRFToken": csrfToken },
    body: formData
  });

  const data = await resp.json();

  if (!data.ok) {
    await refrescarMensajes();

    // cerramos modal en errores fuertes
    if (data.error && data.error.toLowerCase().includes("rate limit")) {
      cerrarModalTarea();
      modoAgregarCancion = false;
      location.reload(); // fuerza el popup y bloqueo del bot√≥n
    }
    
    return;
  }

  // ‚úÖ flujo normal
  cerrarModalTarea();
  modoAgregarCancion = false;

  await refrescarCanciones();
  seleccionarCancionPorRelacion(data.relacion_id);
  await refrescarMensajes();
}



function seleccionarCancionPorRelacion(relacionId) {
  const el = document.querySelector(`.song-row[data-relacion-id="${relacionId}"]`);
  if (el) {
    seleccionarCancion(el);
  }
}

async function refrescarCanciones() {
  try {
    const resp = await fetch(`/editar_playlist/${playlistId}/canciones/`);
    const data = await resp.json();

    if (!data.ok) {
      console.error("Error al refrescar canciones:", data.error);
      return;
    }

    totalCancionesConPendientes = data.total_con_pendientes;

    canciones = data.canciones; // üëâ actualizar array global
    renderizarListaCanciones(); // üëâ re-renderizar la tabla/lista
  } catch (e) {
    console.error("Error de red al refrescar canciones:", e);
  }
}


function renderizarListaCanciones() {
  const contenedor = document.getElementById("lista-canciones");
  contenedor.innerHTML = ""; // limpiar lista

  canciones.forEach(c => {
    const row = document.createElement("div");
    row.classList.add("song-row");
    row.dataset.id = c.id;
    row.dataset.relacionId = c.id_relacion;

    row.innerHTML = `
      <span class="col-idx">${c.posicion || "‚Äî"}</span>
      <span class="col-title">
        ${c.cover_url ? `<img src="${c.cover_url}" alt="Cover ${c.titulo}" class="song-cover">` : ""}
        ${c.titulo}
      </span>
      <span class="col-album">${c.album || ""}</span>
    `;

    row.addEventListener("click", () => seleccionarCancion(row));
    contenedor.appendChild(row);
  });
}



</script>
{% endblock %}