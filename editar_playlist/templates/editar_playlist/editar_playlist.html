{% extends "base.html" %}
{% load static %}

{% block title %}Editar Playlist | {{ playlist.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'editar_playlist/css/editar_playlist.css' %}">
{% endblock %}

{% block content %}
<div id="mensaje-superior" style="display:none;"></div>
<div class="editar-container">
  <!-- Grid principal con 3 columnas -->
  <div class="editar-layout">
    
    <!-- Columna izquierda -->
    <div class="playlist-section">
      <!-- Header grande fijo -->
      <div class="playlist-header">
        {% if playlist.cover_url %}
          <img src="{{ playlist.cover_url }}" alt="Cover {{ playlist.nombre }}" class="playlist-cover-big">
        {% endif %}
        <div class="playlist-info-block">
          <h1 class="playlist-title {% if playlist.nombre|length > 40 %}long{% endif %}">
            {{ playlist.nombre }}
          </h1>
          {% if playlist.descripcion %}
            <p class="playlist-description">{{ playlist.descripcion }}</p>
          {% endif %}
          <p class="playlist-meta">
            {{ playlist.propietario }} ¬∑ {{ playlist.total_canciones }} canciones
          </p>
        </div>
      </div>

      <!-- Encabezado de canciones sticky -->
      <div class="songs-header sticky">
        <span class="col-idx">#</span>
        <span class="col-title">T√≠tulo</span>
        <span class="col-album">√Ålbum</span>
      </div>

      <!-- Lista de canciones -->
      <div class="songs-list">
        {% for c in canciones %}
          <div class="song-row" onclick="seleccionarCancion(this)" data-id="{{ c.id }}" data-relacion-id="{{ c.id_relacion }}">
            <span class="col-idx">{{ c.posicion|default:"‚Äî" }}</span>
            <span class="col-title">
              {% if c.cover_url %}
                <img src="{{ c.cover_url }}" alt="Cover {{ c.titulo }}" class="song-cover">
              {% endif %}
              {{ c.titulo }}
            </span>
            <span class="col-album">{{ c.album }}</span>
          </div>
        {% empty %}
          <p class="empty">Esta playlist no tiene canciones relacionadas.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Columna derecha: detalles y tareas -->
    <div class="details-section">
    <div class="detalle-box datos-cancion">
      <h3>Datos de la canci√≥n</h3>
      <div class="detalle-row">
        <div class="detalle-label">Nombre:</div>
        <div class="detalle-value" id="detalle-nombre">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Autor:</div>
        <div class="detalle-value" id="detalle-artistas">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">√Ålbum:</div>
        <div class="detalle-value" id="detalle-album">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Duraci√≥n:</div>
        <div class="detalle-value" id="detalle-duracion">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Agregada:</div>
        <div class="detalle-value" id="detalle-agregado">‚Äî</div>
      </div>
      <div class="detalle-row">
        <div class="detalle-label">Posici√≥n:</div>
        <div class="detalle-value" id="detalle-posicion">‚Äî</div>
      </div>
    </div>

    <div class="detalle-box tareas">
      <h3>Tareas asignadas</h3>
      <div class="tareas-header sticky">
        <span class="col-accion">Acci√≥n</span>
        <span class="col-posicion">#</span>
        <span class="col-estado">Estado</span>
        <span class="col-fecha">Fecha</span>
      </div>
      <div class="tareas-list" id="lista-tareas">
        <p class="empty">No hay tareas asignadas.</p>
      </div>
      <div class="tarea-actions">
        <button class="action-btn" id="btn-agregar-tarea" disabled>Agregar Tarea</button>
        <button class="action-btn" id="btn-eliminar-tarea" disabled>Eliminar Tarea</button>
      </div>
    </div>
  </div>

    <!-- Columna derecha: acciones -->
   <div class="action-panel">
        <div class="action-buttons-vertical">
            <button class="action-btn" onclick="agregarCancion()">Agregar Canci√≥n</button>
            <button class="action-btn" onclick="volverAtras()">Atr√°s</button>
        </div>
    </div>
  </div>
  
</div>

<div id="modal-tarea" class="modal hidden">
  <div class="modal-content">
    <h2>Agregar Tarea</h2>

    <label for="tipo-tarea">Tipo de tarea</label>
    <select id="tipo-tarea">
      <option value="posicionar">Posicionar</option>
      <option value="eliminar">Eliminar</option>
    </select>

    <div id="campo-posicion" class="campo-dinamico">
      <label for="posicion">Posici√≥n</label>
      <select id="posicion"></select>
    </div>

    <div id="campo-fecha" class="campo-dinamico">
      <label for="fecha-ejecucion">Fecha de ejecuci√≥n</label>
      <input type="date" id="fecha-ejecucion">
    </div>

    <div class="modal-buttons">
      <button class="action-btn" id="btn-confirmar-tarea">Agregar Tarea</button>
      <button class="action-btn" id="btn-cancelar-tarea">Cancelar</button>
    </div>
  </div>
</div>

<script>
  const canciones = JSON.parse('{{ canciones_json|escapejs }}');
  const playlistId = {{ playlist.id_playlist }};

  // Variables globales √∫tiles
  const totalCanciones = {{ playlist.total_canciones|default:0 }};
  let relacionSeleccionadaId = null; // id_relacion de la canci√≥n seleccionada
  let tareaSeleccionadaId = null;    // para eliminar tarea seleccionada (si implementas selecci√≥n en la lista)

  // Abrir modal
  document.getElementById('btn-agregar-tarea').addEventListener('click', () => {
    if (!relacionSeleccionadaId) return;
    abrirModalTarea();
  });

  // Cerrar modal
  document.getElementById('btn-cancelar-tarea').addEventListener('click', cerrarModalTarea);

  function abrirModalTarea() {
    // Tipo por defecto
    const tipoSelect = document.getElementById('tipo-tarea');
    tipoSelect.value = 'posicionar';
    actualizarCamposPorTipo();

    // Posiciones v√°lidas
    poblarPosiciones(totalCanciones);

    // Fecha por defecto hoy
    const hoy = new Date().toISOString().slice(0, 10);
    document.getElementById('fecha-ejecucion').value = hoy;

    document.getElementById('modal-tarea').classList.remove('hidden');
  }

  function cerrarModalTarea() {
    document.getElementById('modal-tarea').classList.add('hidden');
  }

  // Mostrar/ocultar campos seg√∫n tipo
  document.getElementById('tipo-tarea').addEventListener('change', actualizarCamposPorTipo);

  function actualizarCamposPorTipo() {
    const tipo = document.getElementById('tipo-tarea').value;
    const campoPos = document.getElementById('campo-posicion');

    if (tipo === 'posicionar') {
      campoPos.classList.remove('hidden');
    } else if (tipo === 'eliminar') {
      campoPos.classList.add('hidden');
    }
  }

  // Poblar posiciones 1..N
  function poblarPosiciones(n) {
    const sel = document.getElementById('posicion');
    sel.innerHTML = '';
    for (let i = 1; i <= Math.max(1, n); i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      sel.appendChild(opt);
    }
  }


// Confirmar agregar tarea
document.getElementById('btn-confirmar-tarea').addEventListener('click', async () => {
  const tipo = document.getElementById('tipo-tarea').value;
  const fecha = document.getElementById('fecha-ejecucion').value;
  const posicion = document.getElementById('posicion').value;

  const formData = new FormData();
  formData.append('relacion_id', relacionSeleccionadaId);
  formData.append('tipo', tipo);
  formData.append('fecha', fecha);
  if (tipo === 'posicionar') formData.append('posicion', posicion);

  const csrfToken = getCookie('csrftoken');

  try {
    const resp = await fetch("{% url 'crear_tarea' playlist.id_playlist %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      body: formData
    });
    const data = await resp.json();

    if (!data.ok) {
      return; // el backend ya puso el mensaje en la barra superior
    }

    cerrarModalTarea();

    // üëâ Refrescar lista completa desde el servidor
    await refrescarTareas(relacionSeleccionadaId);

    await refrescarMensajes();

    // üëâ El mensaje ya lo maneja Django con messages.success
  } catch (e) {
    console.error("Error de red al crear la tarea", e);
  }
});

// Eliminar tarea
document.getElementById('btn-eliminar-tarea').addEventListener('click', async () => {
  if (!tareaSeleccionadaId) return;

  const c = canciones.find(x => x.id_relacion == relacionSeleccionadaId);
  const tarea = c?.tareas.find(t => t.id_tarea == tareaSeleccionadaId);
  const usuario = tarea?.usuario || "desconocido";

  const confirmacion = confirm(`¬øEst√° seguro de eliminar esta tarea programada por ${usuario}?`);
  if (!confirmacion) return;

  const csrfToken = getCookie('csrftoken');

  try {
    const resp = await fetch(
      "{% url 'eliminar_tarea' playlist.id_playlist 0 %}".replace("0", tareaSeleccionadaId),
      {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken }
      }
    );
    const data = await resp.json();

    if (!data.ok) {
      console.error("Error al eliminar tarea:", data.error || "Respuesta inv√°lida");
      return;
    }

    // üëâ Refrescar tareas desde el servidor
    tareaSeleccionadaId = null;
    await refrescarTareas(relacionSeleccionadaId);

    await refrescarMensajes();

    // üëâ Deshabilitar bot√≥n despu√©s de eliminar
    document.getElementById('btn-eliminar-tarea').disabled = true;

    // El mensaje de √©xito lo maneja Django (messages.success)
    console.log("Tarea eliminada correctamente");
  } catch (e) {
    console.error("Error de red al eliminar la tarea:", e);
  }
});

async function refrescarTareas(relacionId) {
  try {
    const resp = await fetch(`/editar_playlist/${playlistId}/relacion/${relacionId}/tareas/`);
    const data = await resp.json();

    if (!data.ok) {
      console.error("Error al refrescar tareas:", data.error || "Respuesta inv√°lida");
      return;
    }

    const c = canciones.find(x => x.id_relacion == relacionId);
    if (c) {
      c.tareas = data.tareas;   // üëâ actualizamos con lo que viene del servidor
      renderizarTareas(c);      // üëâ re-renderizamos la lista
    }
  } catch (e) {
    console.error("Error de red al refrescar tareas:", e);
  }
}

function renderizarTareas(c) {
  const lista = document.getElementById("lista-tareas");
  lista.innerHTML = "";

  if (c.tareas && c.tareas.length > 0) {
    c.tareas.forEach(t => {
      const row = document.createElement("div");
      row.className = "tarea-row";
      row.dataset.tareaId = t.id_tarea;

      row.innerHTML = `
        <span class="col-accion">${t.tipo}</span>
        <span class="col-posicion">${t.posicion || "‚Äî"}</span>
        <span class="col-estado">${t.estado}</span>
        <span class="col-fecha">${new Date(t.fecha_ejecucion).toLocaleDateString()}</span>
      `;

      // seleccionar tarea para eliminar
      row.addEventListener("click", () => {
        document.querySelectorAll(".tarea-row").forEach(x => x.classList.remove("selected"));
        row.classList.add("selected");
        tareaSeleccionadaId = t.id_tarea;
        document.getElementById("btn-eliminar-tarea").disabled = false;
      });

      lista.appendChild(row);
    });
  } else {
    lista.innerHTML = "<p class='empty'>No hay tareas asignadas.</p>";
  }
}

// Utilidad para CSRF
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
 
function seleccionarCancion(el) {
  // marcar selecci√≥n
  document.querySelectorAll('.song-row').forEach(r => r.classList.remove('selected'));
  el.classList.add('selected');

  // guardar id de relaci√≥n
  relacionSeleccionadaId = el.dataset.relacionId;
  document.getElementById('btn-agregar-tarea').disabled = !relacionSeleccionadaId;
  document.getElementById('btn-eliminar-tarea').disabled = true;

  // buscar canci√≥n en el JSON
  const id = el.dataset.id;
  const c = canciones.find(x => x.id == id);

  if (c) {
    // actualizar detalles
    document.getElementById("detalle-nombre").textContent = c.titulo;
    document.getElementById("detalle-artistas").textContent = c.artistas;
    document.getElementById("detalle-album").textContent = c.album;
    document.getElementById("detalle-duracion").textContent = c.duracion || "‚Äî";
    document.getElementById("detalle-agregado").textContent = c.fecha_agregado ? new Date(c.fecha_agregado).toLocaleDateString() : "‚Äî";
    document.getElementById("detalle-posicion").textContent = c.posicion || "‚Äî";

    // üëâ usar la nueva funci√≥n para renderizar tareas
    renderizarTareas(c);
  }
}

  function volverAtras() {
    window.location.href = "{% url 'lista_playlist_home' %}";
  }

  function agregarCancion() {
    alert("Funcionalidad de agregar canci√≥n en construcci√≥n...");
  }

  function mostrarMensajeSuperior(mensaje, tipo) {
    // tipo puede ser 'success' o 'error'
    const barra = document.getElementById("mensaje-superior");
    if (!barra) return;

    barra.textContent = mensaje;
    barra.className = tipo; // aplica estilos seg√∫n tipo
    barra.style.display = "block";

    setTimeout(() => {
      barra.style.display = "none";
    }, 3000);
  }

  async function refrescarMensajes() {
    try {
      const resp = await fetch("{% url 'mensajes_bar' %}");
      const html = await resp.text();
      document.querySelector(".topbar-center").innerHTML = html;
    } catch (e) {
      console.error("Error al refrescar mensajes:", e);
    }
  }

</script>
{% endblock %}